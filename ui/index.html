<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>BetaBank</title>
    <!-- <link rel="shortcut icon" href="favicon.png" /> -->
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <script src="three.js"></script>
    <script src="OrbitControls.js"></script>
    <script>

      let x = 1280
      let y = 720
      var img = new Image();
      var scene = new THREE.Scene();
      var renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setClearAlpha(0.0);
      var camera = new THREE.PerspectiveCamera( 75, x / y, 0.1, 50 );
      var controls = new THREE.OrbitControls(camera, renderer.domElement);

      //Load background texture
      const loader = new THREE.TextureLoader();

      let socket = new WebSocket("ws://" + window.location.hostname + ":8081");
      socket.binaryType = "arraybuffer"

      socket.onopen = function(e) {
        console.log("Socket opened successfully")
        // socket.send("hola");
      }

      socket.onmessage = function(e) {
        var data = e.data;
        var type = data.substring(0, 10)
        if (type.trim() == "state") {
          state = JSON.parse(data.substring(10))
          // console.log(state);
          update_state(state)
        } else {
          alert("received something else")
        }
      }

      socket.onerror = function(e) {
        console.log("Error ws")
      }



      var point = null


      function update_state(state) {
        //console.log(state)

         if (point == null) {
          var geometry = new THREE.BoxGeometry( 0.025, 0.025, 0.025 )
          var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } )
          point = new THREE.Mesh( geometry, material )
          scene.add( point )
         }
         
        point.position.x = state.tvec[0] * -10
        point.position.y = state.tvec[1] * -10
        point.position.z = state.tvec[2] * 10
        img.src = "data:image/jpg;base64," + state.frame;
        //console.log(state.frame)
        //console.log('Update state called')

        loader.load(img.src  , function(texture)
                  {
                    //console.log(texture)
                  scene.background = texture;  
                  });
      }

      var axesHelper = new THREE.AxesHelper( 5 );
      scene.add( axesHelper )

      renderer.setSize( x, y )
      document.body.appendChild( renderer.domElement )

      var line_material = new THREE.LineBasicMaterial( { color: 0x999999 } );

      let room = []

      camera.position.x = 0
      camera.position.y = 0
      camera.position.z = 0
      camera.up = new THREE.Vector3(0,1,0);
      controls.target = new THREE.Vector3(0,0,1);
      controls.update()
      

      // var fucknuggets = [[ 0.01804225,0.03963027,0.14974374], [ 0.00312152,0.03804705,0.15032733], [-0.01185489,0.0365027, 0.15112753], [-0.02688202,0.03457271,0.15069526], [ 0.01961043,0.02544531,0.15477512], [-0.01025061,0.02217384,0.155899,], [-0.02533745,0.02038764,0.15603517], [ 0.02122473,0.01119154,0.15977895], [ 0.0063187, 0.00955189,0.16059931], [-0.00866816,0.00784225,0.16079996], [-0.02366003,0.00602661,0.16044643], [ 0.00472315,0.02393247,0.15595314]]
      // fucknuggets.forEach(function(frog) {
      //   var geometry = new THREE.BoxGeometry( 0.025, 0.025, 0.025 )
      //   var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } )
      //   cube = new THREE.Mesh( geometry, material )
      //   cube.position.x = frog[0] * 10
      //   cube.position.y = frog[1] * 10
      //   cube.position.z = frog[2] * 10
      //   scene.add( cube )
      // })

      function animate() {
        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene, camera );
      }
      animate();
    </script>
    <div>
      <image id="camera" />
    </div>
    <div style="z-index: 1000; color: white;">
      <p>Things are happening?</p>
    </div>
  </body>
</html>